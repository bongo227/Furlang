box: bongo227/furlang-docker:latest

build:
    steps:
        - script:
            name: Move to gopath
            code: |
                mkdir -p $GOPATH/src/github.com/bongo227/Furlang
                mv * $GOPATH/src/github.com/bongo227/Furlang/
        
        - script:
            name: Populate cache
            code: |
                if test -d "$WERCKER_CACHE_DIR/bin"; then cp -r $WERCKER_CACHE_DIR/bin $GOPATH/bin ; fi
                if test -d "$WERCKER_CACHE_DIR/vendor"; then cp -r $WERCKER_CACHE_DIR/vendor $GOPATH/src/github.com/bongo227/Furlang/ ; fi

        - script:
            name: Install dependencys
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |
                if test ! -d "$WERCKER_CACHE_DIR/bin"; then go get github.com/kardianos/govendor ; fi
                if test ! -d "$WERCKER_CACHE_DIR/bin"; then go get github.com/golang/lint/golint ; fi
                if test ! -d "$WERCKER_CACHE_DIR/bin"; then go get honnef.co/go/unused/cmd/unused ; fi
                govendor sync

        - script:
            name: Build project
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |
                mkdir -p build
                go build -o build/furlang

        - script:
            name: Go test
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |
                govendor test +local
        
        - script:
            name: Intergration Tests
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |
                bash makeTests.sh
                bats build/tests.bats

        - script:
            name: Go lint
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |
                golint
                golint compiler/*

        - script:
            name: Dead code check
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |
                unused
                unused compiler/*

        - script:
            name: Store cache
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |-
                cp -r vendor $WERCKER_CACHE_DIR
                cp -r $GOPATH/bin $WERCKER_CACHE_DIR/bin

dev:
    steps:
        - script:
            name: Setup
            code: |
                mkdir -p $GOPATH/src/github.com/bongo227/
                ln -s /pipeline/source $GOPATH/src/github.com/bongo227/Furlang
                cd $GOPATH/src/github.com/bongo227/Furlang/
                if test -d "$WERCKER_CACHE_DIR/bin"; then cp -r $WERCKER_CACHE_DIR/bin $GOPATH/bin ; fi
                if test ! -d "$WERCKER_CACHE_DIR/bin"; then go get github.com/kardianos/govendor ; fi
                if test ! -d "$WERCKER_CACHE_DIR/bin"; then go get github.com/golang/lint/golint ; fi
                if test ! -d "$WERCKER_CACHE_DIR/bin"; then go get go get honnef.co/go/unused/cmd/unused ; fi
                govendor sync
                mkdir -p build

        - internal/shell:
            cmd: /bin/bash
            cwd: $GOPATH/src/github.com/bongo227/Furlang/
            code: |
                alias help="printf 'build - Builds the compiler\nclean - Cleans up the build directory\ntest - Runs all the tests\nhelp - Prints the help text\n'"
                alias build="go build -o build/furlang"
                alias clean="rm build/*"
                alias test="go test ./... && bash makeTests.sh && bats build/tests.bats && golint ./... && unused ./..."
                alias lint="golint ./..."
                clear
                help